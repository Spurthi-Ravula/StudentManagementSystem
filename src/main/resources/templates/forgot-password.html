<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Student Management System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.css" rel="stylesheet" type="text/css" />
    <link th:href="@{/assets/css/index.css}" rel="stylesheet" />
  </head>
  <body>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
      integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.all.min.js"></script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-5">
      <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/index}">Student Management System</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" th:href="@{/register}">Register</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-6 offset-md-3">
          <div class="card">
            <div class="card-header">
              <h2 class="text-center">Forgot Password</h2>
            </div>
            <div class="card-body">
              <form
                method="post"
                role="form"
                th:action="@{/register/change-password}"
                class="form-horizontal"
                onsubmit="validateForgotPasswordForm()"
                th:object="${ChangePasswordForm}"
              >
                <div class="form-group mb-3" id="email-block">
                  <label for="email" class="control-label"> Email</label>
                  <input type="email" id="email" name="email" class="form-control" required placeholder="Enter email address" />
                  <br />
                  <div class="form-group mb-3">
                    <button class="btn btn-primary" onclick="validateAndSendEmail()">Send email</button>
                  </div>
                </div>

                <div class="form-group mb-3" id="change-password-block" hidden="hidden">
                  <label for="code" class="control-label"> Code</label>
                  <input type="number" id="code" name="code" class="form-control" placeholder="Enter code" maxlength="4" minlength="4" />

                  <label for="password" class="control-label"> Password</label>
                  <input type="password" id="password" name="password" class="form-control" placeholder="Enter password" />
                  <label for="confirmPassword" class="control-label"> Confirm Password</label>
                  <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Confirm password" />
                  <button type="submit" class="btn btn-primary mt-2">Submit</button>
                </div>
                <div class="form-group my-3">
                  <span> Not registered ? <a th:href="@{/register}"> Register/Signup here</a> OR <a th:href="@{/login}">Login</a> </span>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div th:replace="fragments/footer.html :: footer"></div>
    <script>
      function validateForgotPasswordForm() {
        event.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const code = document.getElementById('code').value;
        console.log(email + ' ' + password + ' ' + confirmPassword + ' ' + code);

        if (email.trim() === '' || password.trim() === '' || confirmPassword.trim() === '' || code.trim() === '') {
          alert('Input fields cannot be empty');
          return false;
        }
        if (code.trim().length !== 6) {
          alert('Invalid code');
          return false;
        }

        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        let validatePassword = regex.test(password);
        if (!validatePassword) {
            alert('Password must contain at least one uppercase character, one lowercase character, one symbol, one digit and must contain 8 characters')
            return false;
        }

        if (password !== confirmPassword) {
          alert('Password and confirm password are not same.');
          return false;
        }

        // Make an AJAX request using the Fetch API
        fetch('/register/change-password', {
          method: 'POST', // Adjust the method as needed
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            code: code,
            password: password,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              console.log('Network response was not ok');
            }
            return response;
          })
          .then(async (data) => {
            console.log(data);
            swal({
              title: 'Success!',
              text: 'Password updated!',
              icon: 'success',
              button: 'close!',
            });
            await sleep(2000);
            window.location.href = '/';
          })
          .catch((error) => {
            console.log('werror');
            swal({
              title: 'Failure!',
              text: 'Invalid code',
              icon: 'failure',
              button: 'close!',
            });
          });
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function validateAndSendEmail() {
        event.preventDefault();
        const email = document.getElementById('email').value;
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email.trim() === '' || !regex.test(email)) {
          swal({
            title: 'Failure!',
            text: 'Invalid email address',
            icon: 'failure',
            button: 'close!',
          });
          return false;
        }
        sendEmail(email);
      }

      function sendEmail(email) {
        // Make an AJAX request using the Fetch API
        fetch('/register/forgot-password-email', {
          method: 'POST', // Adjust the method as needed
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            emailAddress: email,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              console.log('Network response was not ok');
            }
            return response.json();
          })
          .then((data) => {
            swal({
              title: 'Success!',
              text: 'Code have been sent to email!',
              icon: 'success',
              button: 'close!',
            });
            document.getElementById('email-block').hidden = true;
            document.getElementById('change-password-block').hidden = false;
          })
          .catch((error) => {
            swal({
              title: 'Failure!',
              text: 'Invalid email address',
              icon: 'failure',
              button: 'close!',
            });
          });
      }
    </script>
  </body>
</html>