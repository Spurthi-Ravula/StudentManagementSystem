<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/head::head}"></head>
  <body>
    <div th:replace="fragments/header.html :: header"></div>

    <div class="container mt-5">
      <div class="row">
        <div class="col-md-12">
          <div id="addAccommodationForm" style="display: none">
            <h3>Add a new Accommodation</h3>
            <form
              action="/add-accommodation"
              th:object="${AddAccommodationForm}"
              method="post"
              class=""
              enctype="multipart/form-data"
              onsubmit="validateAddAccommodationForm()"
            >
              <input hidden="hidden" type="number" class="form-control" id="id" name="id" />

              <div class="form-group">
                <label for="title">Title</label>
                <input type="text" class="form-control" id="title" name="title" placeholder="Enter Accommodation Title" required />
              </div>

              <div class="form-group">
                <label for="price">Accommodation Price</label>
                <input type="number" class="form-control" id="price" name="price" placeholder="Enter Accommodation Price" required />
              </div>

              <div class="form-group">
                <label for="description">Accommodation Description</label>
                <textarea class="form-control" id="description" name="description" placeholder="Enter Accommodation Description" required></textarea>
              </div>

              <div class="form-group">
                <label for="address">Accommodation Address</label>
                <textarea class="form-control" id="address" name="address" placeholder="Enter Accommodation Address" required></textarea>
              </div>

              <div class="form-group">
                <label for="availableFrom">Available From</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="availableFrom"
                  name="availableFrom"
                  placeholder="Enter date of availability"
                  required
                />
              </div>

              <br />
              <div class="preview">
                <img class="rounded-circle text-center" height="110" width="110" id="file-ip-1-preview" alt="Accommodation image" />
              </div>

              <label for="file" class="btn btn-dark btn-block btn-lg" data-mdb-ripple-color="dark">Upload Image </label>
              <input name="file" type="file" id="file" style="display: none" accept="image/*" onchange="showPreview(event);" />

              <br /><br />

              <div class="mb-3 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">Save Accommodation</button>
              </div>

              <br /><br />
            </form>
          </div>

          <div class="mb-5 d-flex justify-content-end">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addAccommodationModal" onclick="toggleForm()">
              Add New Accommodation
            </button>
          </div>

          <h1 class="mb-4 text-center">Reserved Accommodations</h1>
          <table id="reservedAccommodationsTable" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Accommodation Image</th>
                <th>Title</th>
                <th>Description</th>
                <th>Address</th>
                <th>Available From</th>
                <th>Status</th>
                <th>Price</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Category rows will be dynamically added here using Thymeleaf -->
              <tr th:each="accommodation : ${reservedAccommodations}">
                <td>
                  <img
                    th:src="@{'data:image/jpeg;base64,'+${accommodation.generateBase64Image()}}"
                    alt="Accommodation Image"
                    style="max-width: 100px; max-height: 100px"
                    class="accommodation-image"
                  />
                </td>
                <td th:text="${accommodation.title}" id="accommodationName"></td>
                <td th:text="${accommodation.description}"></td>
                <td th:text="${accommodation.address}"></td>
                <td th:text="${accommodation.availableFrom}"></td>
                <td th:text="${accommodation.status}"></td>
                <td th:text="${accommodation.price}"></td>
                <td>
                  <a th:href="@{'/cancel-reserved-accommodation?accommodationId=' + ${accommodation.id}}">
                    <button type="button" class="btn btn-danger btn-sm">Cancel</button>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
          <br /><br />

          <h1 class="mb-4 text-center">My Accommodations</h1>

          <table id="accommodationTable" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Accommodation Image</th>
                <th>Title</th>
                <th>Description</th>
                <th>Address</th>
                <th>Available From</th>
                <th>Status</th>
                <th>Price</th>
                <th>Actions</th>
                <th hidden="hidden">id</th>
              </tr>
            </thead>
            <tbody>
              <!-- Category rows will be dynamically added here using Thymeleaf -->
              <tr th:each="accommodation : ${accommodations}">
                <td>
                  <img
                    th:src="@{'data:image/jpeg;base64,'+${accommodation.generateBase64Image()}}"
                    alt="Accommodation Image"
                    style="max-width: 100px; max-height: 100px"
                    class="accommodation-image"
                  />
                </td>
                <td th:text="${accommodation.title}" id="accommodationName"></td>
                <td th:text="${accommodation.description}"></td>
                <td th:text="${accommodation.address}"></td>
                <td th:text="${accommodation.availableFrom}"></td>
                <td th:text="${accommodation.status}"></td>
                <td th:text="${accommodation.price}"></td>
                <td>
                  <button type="button" class="btn btn-primary btn-sm edit-button">Edit</button>
                  <a th:href="@{'/delete-accommodation?accommodationId=' + ${accommodation.id}}">
                    <button type="button" class="btn btn-danger btn-sm">Delete</button>
                  </a>
                </td>
                <td th:text="${accommodation.id}" hidden="hidden"></td>
              </tr>
            </tbody>
          </table>
          <br /><br />
        </div>
        <input th:value="${success}" disabled hidden="hidden" id="accommodationAdded" />
        <input th:value="${message}" disabled hidden="hidden" id="message" />
      </div>
    </div>

    <div th:replace="~{fragments/footer::footer}"></div>

    <script>
      $(document).ready(function () {
        // Initialize DataTable for reserved accommodations table
        $('#reservedAccommodationsTable').DataTable({
          order: [], // Disable initial sorting
        });

        // Initialize DataTable for accommodations table
        $('#accommodationTable').DataTable({
          order: [], // Disable initial sorting
        });
      });

      document.addEventListener('DOMContentLoaded', function () {
        const accommodationAdded = document.getElementById('accommodationAdded').value;
        const priceInput = document.getElementById('price');
        const editButtons = document.querySelectorAll('.edit-button');
        const dateTimeInput = document.getElementById('availableFrom');
        const currentDate = new Date();
        const formattedCurrentDate = currentDate.toISOString().slice(0, 16);

        dateTimeInput.min = formattedCurrentDate;

        if (accommodationAdded != 'null') {
          const message = document.getElementById('message').value;

          if (accommodationAdded === 'true') {
            swal({
              title: 'Success!',
              text: message,
              icon: 'success',
              button: 'close!',
            });
          } else if (accommodationAdded === 'false') {
            swal({
              title: 'Failure!',
              text: message,
              icon: 'failure',
              button: 'close!',
            });
          }
        }

        editButtons.forEach((button) => {
          button.addEventListener('click', function () {
            const form = document.getElementById('addAccommodationForm');
            const row = this.closest('tr');

            document.getElementById('title').value = row.querySelector('td:nth-child(2)').textContent.trim();
            document.getElementById('price').value = row.querySelector('td:nth-child(7)').textContent.trim();
            document.getElementById('description').value = row.querySelector('td:nth-child(3)').textContent.trim();
            document.getElementById('address').value = row.querySelector('td:nth-child(4)').textContent.trim();
            document.getElementById('id').value = row.querySelector('td:nth-child(9)').textContent.trim();
            const datetime = new Date(row.querySelector('td:nth-child(5)').textContent.trim());
            const formattedDatetime =
              datetime.getFullYear() +
              '-' +
              ('0' + (datetime.getMonth() + 1)).slice(-2) +
              '-' +
              ('0' + datetime.getDate()).slice(-2) +
              'T' +
              ('0' + datetime.getHours()).slice(-2) +
              ':' +
              ('0' + datetime.getMinutes()).slice(-2);

            document.getElementById('availableFrom').value = formattedDatetime;

            const imageSrc = row.querySelector('.accommodation-image').getAttribute('src');

            const preview = document.getElementById('file-ip-1-preview');
            preview.src = imageSrc;
            preview.style.display = '';

            form.style.display = 'block';
          });
        });

        priceInput.addEventListener('input', function (event) {
          const price = parseFloat(event.target.value);
          if (price < 0) {
            event.target.value = 0;
          }
        });
      });

      function toggleForm() {
        var form = document.getElementById('addAccommodationForm');
        document.getElementById('id').value = 0;
        if (form.style.display === 'none') {
          form.style.display = 'block';
        } else {
          form.style.display = 'none';
        }
      }

      function showPreview(event) {
        if (event.target.files.length > 0) {
          const src = URL.createObjectURL(event.target.files[0]);
          const preview = document.getElementById('file-ip-1-preview');
          preview.src = src;
          preview.style.display = '';
        }
      }

      function validateAddAccommodationForm() {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const address = document.getElementById('address').value;
        const availableFrom = document.getElementById('availableFrom').value;
        const id = document.getElementById('id').value;
        const fileInput = document.getElementById('file');
        const file = fileInput.files[0];

        if (title.trim() === '' || price.trim() === '' || description.trim() === '' || address.trim() === '' || availableFrom.trim() === '') {
          swal({
            title: 'Failure!',
            text: 'Input fields cannot be empty',
            icon: 'failure',
            button: 'close!',
          });

          event.preventDefault();
          return false;
        }

        if (file) {
          const fileSize = file.size; // Size of the file in bytes
          const maxSize = 2 * 1024 * 1024; // 2 MB in bytes

          if (fileSize > maxSize) {
            swal({
              title: 'Failure!',
              text: 'File size cannot be more than 2MB',
              icon: 'failure',
              button: 'close!',
            });
            event.preventDefault();
            return false;
          }
        } else if (!id) {
          swal({
            title: 'Failure!',
            text: 'Please upload image',
            icon: 'failure',
            button: 'close!',
          });
          event.preventDefault();
          return false;
        }
      }
    </script>
  </body>
</html>
